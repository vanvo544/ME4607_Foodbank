<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Đăng Nhập & Đăng Ký</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome cho icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        /* Hiệu ứng mượt mà cho input */
        .input-field {
            transition: all 0.2s ease-in-out;
        }
        .input-field:focus {
            border-color: #000;
            box-shadow: 0 0 0 1px #000;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        
        /* Ẩn hiện form */
        .hidden-form {
            display: none;
        }
        
        /* Style cho vùng upload ảnh */
        .upload-area {
            border: 2px dashed #cbd5e1;
            transition: all 0.2s;
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: #000;
            background-color: #f8fafc;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Container chính -->
    <!-- Đã thêm h-[85vh] và overflow-y-auto để cố định chiều cao và cho phép cuộn nội dung -->
    <div class="bg-white w-full max-w-2xl h-[85vh] rounded-2xl shadow-xl p-8 md:p-12 relative overflow-y-auto">
        
        <!-- --- FORM ĐĂNG NHẬP --- -->
        <div id="loginSection">
            <div class="text-center mb-10">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Đăng nhập</h1>
                <p class="text-gray-500">Nhập thông tin để truy cập hệ thống</p>
            </div>

            <form id="loginForm" class="space-y-6">
                <!-- Phone Number -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Số điện thoại</label>
                    <input type="tel" placeholder="+84 912 345 678" class="input-field w-full px-4 py-3 rounded-lg border border-gray-300 outline-none text-gray-900 placeholder-gray-400 bg-gray-50" required>
                </div>

                <!-- Password -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mật khẩu</label>
                    <input type="password" placeholder="Nhập mật khẩu" class="input-field w-full px-4 py-3 rounded-lg border border-gray-300 outline-none text-gray-900 placeholder-gray-400 bg-gray-50" required>
                </div>

                <!-- Actions -->
                <div class="flex items-center justify-between text-sm">
                    <label class="flex items-center text-gray-600 cursor-pointer">
                        <input type="checkbox" class="mr-2 rounded text-black focus:ring-black">
                        Ghi nhớ đăng nhập
                    </label>
                    <a href="#" class="font-medium text-black hover:underline">Quên mật khẩu?</a>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="w-full bg-black text-white font-bold py-4 rounded-lg hover:bg-gray-800 transition duration-300 transform hover:scale-[1.01]">
                    Đăng nhập
                </button>
            </form>

            <div class="mt-8 text-center text-sm text-gray-600">
                Chưa có tài khoản? 
                <button onclick="toggleView('register')" class="font-bold text-black hover:underline ml-1">Đăng ký ngay</button>
            </div>
        </div>


        <!-- --- FORM ĐĂNG KÝ --- -->
        <div id="registerSection" class="hidden-form">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Tạo tài khoản mới</h1>
                <p class="text-gray-500">Chọn vai trò và điền thông tin chi tiết</p>
            </div>

            <form id="registerForm" class="space-y-6">
                
                <!-- Role Selection -->
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                    <label class="block text-sm font-bold text-gray-900 mb-3">Bạn là đối tượng nào?</label>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <label class="cursor-pointer">
                            <input type="radio" name="role" value="volunteer" class="peer sr-only" checked onchange="renderFields()">
                            <div class="text-center py-3 px-2 rounded-lg border border-gray-300 bg-white text-gray-600 peer-checked:bg-black peer-checked:text-white peer-checked:border-black transition-all hover:bg-gray-100">
                                <i class="fa-solid fa-hand-holding-heart mb-1 block"></i> Volunteer
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="role" value="leader" class="peer sr-only" onchange="renderFields()">
                            <div class="text-center py-3 px-2 rounded-lg border border-gray-300 bg-white text-gray-600 peer-checked:bg-black peer-checked:text-white peer-checked:border-black transition-all hover:bg-gray-100">
                                <i class="fa-solid fa-bullhorn mb-1 block"></i> Leader
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="role" value="household" class="peer sr-only" onchange="renderFields()">
                            <div class="text-center py-3 px-2 rounded-lg border border-gray-300 bg-white text-gray-600 peer-checked:bg-black peer-checked:text-white peer-checked:border-black transition-all hover:bg-gray-100">
                                <i class="fa-solid fa-house-user mb-1 block"></i> Household
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Common Fields -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Số điện thoại *</label>
                        <input type="tel" placeholder="+84..." class="input-field w-full px-4 py-3 rounded-lg border border-gray-300 bg-white" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mật khẩu *</label>
                        <input type="password" placeholder="Tạo mật khẩu" class="input-field w-full px-4 py-3 rounded-lg border border-gray-300 bg-white" required>
                    </div>
                </div>

                <!-- Dynamic Fields Container -->
                <div id="dynamicFields" class="space-y-5 animate-fade-in">
                    <!-- Fields will be injected here by JS -->
                </div>

                <!-- Submit Button -->
                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="toggleView('login')" class="w-1/3 border border-gray-300 text-gray-700 font-bold py-3 rounded-lg hover:bg-gray-50 transition">
                        Quay lại
                    </button>
                    <button type="submit" class="w-2/3 bg-black text-white font-bold py-3 rounded-lg hover:bg-gray-800 transition shadow-lg transform hover:translate-y-[-1px]">
                        Tiếp tục
                    </button>
                </div>
            </form>
        </div>

    </div>

    <!-- JAVASCRIPT LOGIC -->
<script>
// ================== CẤU HÌNH TRƯỜNG ĐĂNG KÝ THEO ROLE ==================
const roleConfigs = {
  volunteer: [
    { type: 'header', text: 'Thông tin cá nhân' },
    { type: 'text', key: 'fullName', label: 'Họ và tên', placeholder: 'Nguyễn Văn A' },
    { type: 'email', label: 'Email', placeholder: 'abc@gmail.com' },
    { type: 'text', label: 'Địa chỉ', placeholder: 'Số nhà, đường, phường/xã, quận/huyện' },

    { type: 'header', text: 'Thông tin hỗ trợ' },
    { type: 'select', label: 'Phương tiện tham gia', options: ['Xe máy', 'Xe tải nhỏ', 'Xe ba gác', 'Không có phương tiện'] },
    { type: 'text', label: 'Biển số xe (nếu có)', placeholder: '59A1-123.45' },

    { type: 'header', text: 'Hồ sơ minh chứng' },
    { type: 'file', label: 'Ảnh chân dung', accept: 'image/*' },
    { type: 'file', label: 'Ảnh CCCD/CMND (mặt trước)', accept: 'image/*' },
    { type: 'file', label: 'Ảnh CCCD/CMND (mặt sau)', accept: 'image/*' }
  ],
  leader: [
    { type: 'header', text: 'Thông tin cá nhân' },
    { type: 'text', key: 'fullName', label: 'Họ và tên', placeholder: 'Nguyễn Văn B' },
    { type: 'email', label: 'Email', placeholder: 'abc@gmail.com' },

    { type: 'header', text: 'Khu vực phụ trách' },
    { type: 'text', label: 'Tỉnh/Thành phố', placeholder: 'TP. Hồ Chí Minh' },
    { type: 'text', label: 'Quận/Huyện', placeholder: 'Quận 4' },
    { type: 'text', label: 'Phường/Xã', placeholder: 'Phường 1' },
    { type: 'text', label: 'Khu phố/Tổ dân phố', placeholder: 'Khu phố 2' },

    { type: 'header', text: 'Minh chứng' },
    { type: 'file', label: 'Ảnh quyết định/bổ nhiệm (nếu có)', accept: 'image/*,application/pdf' }
  ],
  household: [
    { type: 'header', text: 'Thông tin chủ hộ' },
    { type: 'text', key: 'fullName', label: 'Họ và tên chủ hộ', placeholder: 'Nguyễn Văn C' },

    { type: 'header', text: 'Địa chỉ hộ' },
    { type: 'text', label: 'Địa chỉ chi tiết', placeholder: 'Số nhà, đường, phường/xã, quận/huyện' },
    { type: 'text', label: 'Tỉnh/Thành phố', placeholder: 'TP. Hồ Chí Minh' },
    { type: 'text', label: 'Quận/Huyện', placeholder: 'Quận 4' },
    { type: 'text', label: 'Phường/Xã', placeholder: 'Phường 1' },

    { type: 'header', text: 'Minh chứng' },
    { type: 'file', label: 'Ảnh sổ hộ khẩu / sổ tạm trú (nếu có)', accept: 'image/*' }
  ]
};

// ================== HỖ TRỢ UI ĐĂNG KÝ ==================
function toggleView(view) {
  const loginSection = document.getElementById('loginSection');
  const registerSection = document.getElementById('registerSection');

  if (view === 'register') {
    loginSection?.classList.add('hidden-form');
    registerSection?.classList.remove('hidden-form');
    renderFields();
  } else {
    registerSection?.classList.add('hidden-form');
    loginSection?.classList.remove('hidden-form');
  }
}

function createFileField(label, accept) {
  return `
    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-2">${label}</label>
      <div class="upload-area relative w-full h-32 flex items-center justify-center cursor-pointer group hover:bg-gray-100 border-dashed border rounded-lg">
        <input type="file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" accept="${accept || 'image/*'}" onchange="previewImage(this)">
        <div class="text-center pointer-events-none z-0">
          <i class="fa-solid fa-cloud-arrow-up text-2xl text-gray-400 mb-2 group-hover:text-black transition-colors"></i>
          <p class="text-xs text-gray-500"><span class="font-bold text-black">Click để tải</span> hoặc kéo thả</p>
          <p class="text-[10px] text-gray-400 mt-1">PNG, JPG (Max 5MB)</p>
        </div>
        <div class="preview-container hidden absolute inset-0 w-full h-full bg-white rounded-lg p-1 z-20 pointer-events-none">
          <img src="" class="w-full h-full object-cover rounded-md" alt="Preview">
        </div>
      </div>
    </div>
  `;
}

function createField(field) {
  if (field.type === 'header') {
    return `<h3 class="text-sm font-semibold text-gray-900 mt-6 mb-2">${field.text}</h3>`;
  }

  if (field.type === 'file') {
    return createFileField(field.label, field.accept);
  }

  if (field.type === 'select') {
    const opts = field.options.map(o => `<option value="${o}">${o}</option>`).join('');
    return `
      <div class="mb-3">
        <label class="block text-sm font-medium text-gray-700 mb-2">${field.label}</label>
        <div class="relative">
          <select class="w-full px-4 py-3 rounded-lg border border-gray-300 bg-white outline-none appearance-none cursor-pointer">
            ${opts}
          </select>
          <div class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-gray-400">
            <i class="fa-solid fa-chevron-down text-xs"></i>
          </div>
        </div>
      </div>
    `;
  }

  const dataAttr = field.key ? `data-field="${field.key}"` : "";
  return `
    <div class="mb-3">
      <label class="block text-sm font-medium text-gray-700 mb-2">${field.label}</label>
      <input type="${field.type}" ${dataAttr} placeholder="${field.placeholder || ''}" class="w-full px-4 py-3 rounded-lg border border-gray-300 outline-none bg-white text-gray-900" required>
    </div>
  `;
}

function renderFields() {
  const roleInput = document.querySelector('input[name="role"]:checked');
  const role = roleInput ? roleInput.value : 'volunteer';
  const config = roleConfigs[role] || [];
  const container = document.getElementById('dynamicFields');
  if (!container) return;
  container.innerHTML = config.map(createField).join('');
  setupDragAndDrop();
}

function setupDragAndDrop() {
  const uploadAreas = document.querySelectorAll('.upload-area');

  uploadAreas.forEach(area => {
    const fileInput = area.querySelector('input[type="file"]');
    const previewContainer = area.querySelector('.preview-container');
    const previewImg = previewContainer ? previewContainer.querySelector('img') : null;

    area.addEventListener('dragover', (e) => {
      e.preventDefault();
      area.classList.add('dragover');
    });

    area.addEventListener('dragleave', () => {
      area.classList.remove('dragover');
    });

    area.addEventListener('drop', (e) => {
      e.preventDefault();
      area.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) {
        fileInput.files = e.dataTransfer.files;
        showPreview(fileInput, previewContainer, previewImg);
      }
    });

    if (fileInput) {
      fileInput.addEventListener('change', () => {
        const file = fileInput.files[0];
        if (file) showPreview(fileInput, previewContainer, previewImg);
      });
    }
  });
}

function showPreview(input, previewContainer, previewImg) {
  if (!previewContainer || !previewImg) return;
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    previewImg.src = e.target.result;
    previewContainer.classList.remove('hidden');
  };
  reader.readAsDataURL(file);
}

function previewImage(input) {
  const area = input.closest('.upload-area');
  if (!area) return;
  const previewContainer = area.querySelector('.preview-container');
  const previewImg = previewContainer ? previewContainer.querySelector('img') : null;
  if (!previewContainer || !previewImg) return;
  showPreview(input, previewContainer, previewImg);
}

// ================== LOGIN DEMO THEO SỐ ĐIỆN THOẠI ==================
// 0918956342 -> Admin (orders.html)
// 0908956342 -> Community Leader (for_CL/index.html)
// 0978956342 -> Volunteer   (chưa làm giao diện riêng)
// 0928956342 -> Household   (chưa làm giao diện riêng)
const TEST_ACCOUNTS = {
  "0918956342": { role: "admin",            redirect: "for_admin/orders.html" },
  "0908956342": { role: "community_leader", redirect: "for_CL/index.html" },
  "0978956342": { role: "volunteer",        redirect: "for_V/index.html" },
  "0928956342": { role: "household",        redirect: "for_HH/index.html" }
};



function handleLoginSubmit(e) {
  e.preventDefault();
  const phoneInput = document.querySelector('#loginForm input[type="tel"]');
  const raw = (phoneInput?.value || "").trim();

  // Normalize phone input: remove non-digits, convert +84/84... to leading 0
  let phone = raw.replace(/\D/g, ''); // keep digits only
  if (phone.startsWith('84') && phone.length >= 11) {
    phone = '0' + phone.slice(2);
  }
  if (!phone) {
    alert("Vui lòng nhập số điện thoại.");
    return;
  }

  // Helpful debug output in console when testing
  console.log('Login attempt phone(normalized)=', phone, 'raw=', raw);

  const config = TEST_ACCOUNTS[phone];
  if (!config) {
    alert(
      "Số điện thoại này chưa được cấu hình trong bộ tài khoản test.\n\n" +
      "Hãy dùng một trong các số sau:\n" +
      "- Admin: 0918956342\n" +
      "- Community leader: 0908956342\n" +
      "- Volunteer: 0978956342\n" +
      "- Household: 0928956342"
    );
    return;
  }

  const user = { phone, role: config.role };
  localStorage.setItem("currentUser", JSON.stringify(user));

  // Robust redirect: try several candidate URLs (handles serving from /public or repo root)
  async function tryRedirect(relPath) {
    const seen = new Set();
    const candidates = [];

    // Helper to add absolute URL candidates
    function addCandidate(base, rel) {
      try {
        const u = new URL(rel, base).href;
        if (!seen.has(u)) {
          seen.add(u);
          candidates.push(u);
        }
      } catch (err) {}
    }

    // Build candidate bases
    const currentHref = location.href;
    const origin = location.origin;
    const currentDir = origin + location.pathname.replace(/\/[^/]*$/, '/') ;
    addCandidate(currentHref, relPath);
    addCandidate(currentDir, relPath);
    addCandidate(origin + '/', relPath);
    addCandidate(origin + '/public/', relPath.replace(/^\/+/, ''));
    addCandidate(currentDir, '../' + relPath);

    // Also try raw relPath if it's already absolute-ish
    try {
      const raw = new URL(relPath, location.href).href;
      if (!seen.has(raw)) { seen.add(raw); candidates.push(raw); }
    } catch (err) {}

    // Try each candidate with fetch to see if it exists, then navigate
    for (const url of candidates) {
      try {
        const resp = await fetch(url, { method: 'GET', cache: 'no-store' });
        if (resp && resp.ok) {
          console.log('Redirecting to', url);
          location.href = url;
          return true;
        }
      } catch (err) {
        // ignore fetch errors and try next
        console.warn('Fetch failed for', url, err);
      }
    }

    return false;
  }

  (async () => {
    const ok = await tryRedirect(config.redirect);
    if (!ok) {
      alert('Đã đăng nhập nhưng không thể mở trang đích tự động.\n' +
            'Thử mở thủ công: ' + config.redirect + '\n(hoặc chạy web server từ project root so /for_CL is reachable)');
      console.warn('Tried redirects but none succeeded for', config.redirect);
    }
  })();
}

// ================== ĐĂNG KÝ -> LƯU VÀO localStorage ĐỂ ADMIN DUYỆT ==================
const PENDING_ACCOUNTS_STORAGE_KEY = "fb_pendingAccounts";

function collectRegisterFullName() {
  const container = document.getElementById("dynamicFields");
  if (!container) return "";
  const input = container.querySelector('input[data-field="fullName"]');
  return input ? input.value.trim() : "";
}

function collectRegisterDocs() {
  const docs = [];
  const uploadAreas = document.querySelectorAll("#registerForm .upload-area");
  uploadAreas.forEach((area) => {
    const input = area.querySelector('input[type="file"]');
    if (!input || !input.files || input.files.length === 0) return;
    const labelEl = area.parentElement.querySelector("label");
    const type = labelEl ? labelEl.textContent.trim() : "Tài liệu";
    const filename = input.files[0].name || "file_upload";
    docs.push({ type, filename });
  });
  return docs;
}

function mapRegisterRoleToAccountRole(registerRole) {
  switch (registerRole) {
    case "volunteer": return "VOLUNTEER";
    case "leader":    return "CL";
    case "household": return "HH";
    default:          return "VOLUNTEER";
  }
}

function handleRegisterSubmit(e) {
  e.preventDefault();

  const roleInput = document.querySelector('input[name="role"]:checked');
  const registerRole = roleInput ? roleInput.value : "volunteer";

  const phoneInput = document.querySelector('#registerForm input[type="tel"]');
  const phone = (phoneInput?.value || "").trim();

  const fullName = collectRegisterFullName();
  if (!fullName) {
    alert("Vui lòng nhập Họ và tên / Họ tên chủ hộ.");
    return;
  }
  if (!phone) {
    alert("Vui lòng nhập số điện thoại.");
    return;
  }

  const accountRole = mapRegisterRoleToAccountRole(registerRole);
  const docs = collectRegisterDocs();

  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, "0");
  const dd = String(today.getDate()).padStart(2, "0");
  const registeredAt = `${yyyy}-${mm}-${dd}`;

  const newAccount = {
    id: Date.now(),
    role: accountRole,
    fullName,
    phone,
    registeredAt,
    status: "PENDING",
    docs
  };

  try {
    const raw = localStorage.getItem(PENDING_ACCOUNTS_STORAGE_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    const list = Array.isArray(arr) ? arr : [];
    list.push(newAccount);
    localStorage.setItem(PENDING_ACCOUNTS_STORAGE_KEY, JSON.stringify(list));
  } catch (err) {
    console.error("Không thể lưu account pending vào localStorage", err);
  }

  alert("Đăng ký thành công! Tài khoản của bạn sẽ chờ Admin kiểm duyệt trong màn hình Accounts.");
  toggleView('login');
}

// ================== INIT ==================
document.addEventListener("DOMContentLoaded", () => {
  renderFields();
  setupDragAndDrop();

  const loginForm = document.getElementById("loginForm");
  if (loginForm) loginForm.addEventListener("submit", handleLoginSubmit);

  const registerForm = document.getElementById("registerForm");
  if (registerForm) registerForm.addEventListener("submit", handleRegisterSubmit);
});
</script>




</body>
</html>